---
# User Config + Tools Bootstrap Playbook für thomsible
# Konfiguriert User (Fish shell, PATH) UND installiert moderne CLI-Tools
# OHNE Service-User
#
# Verwendung:
#   ansible-playbook bootstrap_tools.yml -e "target_user=thomas"

- name: "Thomsible User Config + Tools Bootstrap"
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    # WICHTIG: target_user muss explizit gesetzt werden!
    # Beispiel: -e "target_user=thomas"

    # Modern Tools werden aus defaults/main.yml der modern_tools Rolle geladen
    # Alle Tools sind standardmäßig aktiviert (enabled: true)
    # Einzelne Tools können deaktiviert werden mit:
    # tools_config:
    #   termshark:
    #     enabled: false

    # Features aktivieren
    create_shell_aliases: true
    install_system_tools: true
    configure_git: true
    setup_shell_integration: true
    github_tools_check_conflicts: true

    # GitHub Token (optional für höhere API-Limits)
    github_token: "{{ lookup('env', 'GITHUB_TOKEN') | default('') }}"

    # Starship Konfiguration kommt aus yast dotfile sync

  pre_tasks:
    - name: "Validate target_user is defined"
      ansible.builtin.fail:
        msg: "target_user must be explicitly defined! Example: ansible-playbook bootstrap_tools.yml -e 'target_user=thomas'"
      when: target_user is not defined or target_user == ""

    - name: "Display user config + tools bootstrap configuration"
      ansible.builtin.debug:
        msg: "THOMSIBLE USER CONFIG + TOOLS BOOTSTRAP - Target: {{ target_user }}@{{ ansible_distribution }} {{ ansible_distribution_version }}, Will configure: fish shell, PATH, then install modern CLI tools from central configuration, system tools, git config, shell integrations. NO service user will be created!"

  roles:
    # Target User Configuration (Fish shell, PATH, etc.)
    - role: target_user_config
      tags: [target_user_config]

    # Modern Tools Installation
    - role: modern_tools
      tags: [modern_tools]

  post_tasks:
    - name: "User config + tools bootstrap completion"
      ansible.builtin.debug:
        msg: "USER CONFIG + TOOLS BOOTSTRAP COMPLETED! Configured for {{ target_user }}: fish shell, PATH, then installed modern CLI tools from central configuration, system tools, git config{% if create_shell_aliases %}, shell aliases{% endif %}. Next: logout/login, test tools, setup atuin. No service user created."
